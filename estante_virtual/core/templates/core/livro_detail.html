{% extends 'core/base.html' %}

{% block content %}
<div id="detalhes-livro" style="display: flex; gap: 20px; margin-bottom: 2rem;">
    <div id="livro-capa"></div>
    <div id="livro-info"></div>
</div>

<hr>

<div id="secao-resenhas">
    <h2>Resenhas</h2>

    <div id="form-resenha" style="background: #f9f9f9; padding: 1rem; border-radius: 5px; margin-bottom: 2rem;">
        <h4>Adicionar uma nova resenha</h4>
        <div style="margin-bottom: 10px;">
            <label for="nota">Nota (1 a 5):</label>
            <select id="nota" name="nota">
                <option value="5">5 - Excelente</option>
                <option value="4">4 - Muito Bom</option>
                <option value="3">3 - Bom</option>
                <option value="2">2 - Razoável</option>
                <option value="1">1 - Ruim</option>
            </select>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="comentario">Comentário:</label><br>
            <textarea id="comentario" name="comentario" rows="4" style="width: 100%;"></textarea>
        </div>
        <button onclick="adicionarResenha()">Enviar Resenha</button>
    </div>

    <div id="lista-resenhas">
        </div>
</div>

<script>
    const livroId = window.location.pathname.split('/')[2];

    document.addEventListener('DOMContentLoaded', () => {
        carregarDetalhesDoLivro(livroId);
    });

    async function carregarDetalhesDoLivro(id) {
        fetchDetalhesDoLivro(id);
        fetchResenhasDoLivro(id);
    }

    async function fetchDetalhesDoLivro(id) {
        try {
            const response = await fetch(`/api/livros/${id}/`);
            const livro = await response.json();

            document.getElementById('livro-capa').innerHTML = `<img src="${livro.url_capa}" alt="Capa de ${livro.título}" style="max-width: 200px;">`;
            document.getElementById('livro-info').innerHTML = `
                <h2>${livro.título}</h2>
                <p><strong>Autor:</strong> ${livro.autor}</p>
                <p><strong>Ano de Publicação:</strong> ${livro.ano_publicacao}</p>
            `;
        } catch (error) {
            console.error('Erro ao buscar detalhes do livro:', error);
        }
    }

    async function fetchResenhasDoLivro(id) {
        const listaResenhasDiv = document.getElementById('lista-resenhas');
        listaResenhasDiv.innerHTML = '<p>Carregando resenhas...</p>';
        try {
            const response = await fetch(`/api/resenhas/?livro=${id}`);
            const resenhas = await response.json();

            listaResenhasDiv.innerHTML = '';
            if (resenhas.length === 0) {
                listaResenhasDiv.innerHTML = '<p>Ainda não há resenhas para este livro. Seja o primeiro!</p>';
            } else {
                resenhas.forEach(resenha => {
                    const resenhaDiv = document.createElement('div');
                    resenhaDiv.style = 'border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;';
                    resenhaDiv.innerHTML = `
                        <p><strong>Nota: ${resenha.nota}/5</strong></p>
                        <p>${resenha.comentario}</p>
                    `;
                    listaResenhasDiv.appendChild(resenhaDiv);
                });
            }
        } catch (error) {
            console.error('Erro ao buscar resenhas:', error);
        }
    }


    async function adicionarResenha() {
        const nota = document.getElementById('nota').value;
        const comentario = document.getElementById('comentario').value;

        const dadosResenha = {
            livro: livroId, 
            nota: parseInt(nota),
            comentario: comentario
        };

        try {
            const response = await fetch('/api/resenhas/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(dadosResenha)
            });

            if (response.status === 201) {
                alert('Resenha adicionada com sucesso!');
                document.getElementById('comentario').value = '';
                fetchResenhasDoLivro(livroId);
            } else {
                alert('Ocorreu um erro ao adicionar a resenha.');
            }
        } catch (error) {
            console.error('Erro ao adicionar resenha:', error);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}